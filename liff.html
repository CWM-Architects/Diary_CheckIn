<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰“å¡ç³»çµ± - LIFF</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen p-4">
    <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md text-center">
        <h1 class="text-2xl font-bold mb-6 text-blue-600">ğŸ“ LIFF æ™ºæ…§æ‰“å¡</h1>
        
        <div id="status-container" class="mb-6">
            <div id="loading" class="flex flex-col items-center">
                <div class="loading-spinner mb-2"></div>
                <p class="text-gray-500" id="loading-text">æ­£åœ¨åˆå§‹åŒ– LIFF...</p>
            </div>
            
            <div id="main-content" class="hidden">
                <p class="text-lg font-medium text-gray-800 mb-2">æ‚¨å¥½ï¼Œ<span id="user-name">ä½¿ç”¨è€…</span></p>
                <div class="bg-blue-50 p-4 rounded-lg mb-4 text-left">
                    <p class="text-sm text-gray-600">ğŸŒ ç›®å‰ IP: <span id="client-ip" class="font-mono font-bold">è®€å–ä¸­...</span></p>
                    <p class="text-sm text-gray-600">ğŸ“ å®šä½ç‹€æ…‹: <span id="location-status" class="font-bold">ç­‰å¾…ä¸­...</span></p>
                </div>
                
                <div class="space-y-4">
                    <button id="punch-in-btn" class="w-full py-4 bg-green-500 hover:bg-green-600 text-white rounded-xl text-xl font-bold transition-all transform active:scale-95 shadow-md">
                        ä¸Šç­æ‰“å¡
                    </button>
                    <button id="punch-out-btn" class="w-full py-4 bg-orange-500 hover:bg-orange-600 text-white rounded-xl text-xl font-bold transition-all transform active:scale-95 shadow-md">
                        ä¸‹ç­æ‰“å¡
                    </button>
                </div>
            </div>
        </div>

        <div id="message-el" class="mt-4 p-3 rounded-lg hidden"></div>
        
        <p class="mt-8 text-xs text-gray-400">Â© 2026 Diary Check-In System</p>
    </div>

    <script>
        const LIFF_ID = "2008825122-ynaEeEG3";
        let userProfile = null;
        let userIp = "";
        let userLat = 0;
        let userLng = 0;

        async function init() {
            try {
                // 1. åˆå§‹åŒ– LIFF
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                
                userProfile = await liff.getProfile();
                document.getElementById('user-name').textContent = userProfile.displayName;
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('main-content').classList.remove('hidden');

                // 2. ç²å–ä½¿ç”¨è€… IP
                getClientIp();
                
                // 3. ç¶å®šæŒ‰éˆ•
                document.getElementById('punch-in-btn').onclick = () => doPunch('ä¸Šç­');
                document.getElementById('punch-out-btn').onclick = () => doPunch('ä¸‹ç­');

            } catch (err) {
                showMessage("åˆå§‹åŒ–å¤±æ•—: " + err.message, "error");
            }
        }

        async function getClientIp() {
            try {
                const res = await fetch('https://api.ipify.org?format=json');
                const data = await res.json();
                userIp = data.ip;
                document.getElementById('client-ip').textContent = userIp;
            } catch (err) {
                document.getElementById('client-ip').textContent = "ç„¡æ³•å–å¾— (è«‹æª¢æŸ¥ç¶²è·¯)";
                showMessage("ç„¡æ³•å–å¾—æ‚¨çš„ IPï¼Œå¯èƒ½æœƒå°è‡´é©—è­‰å¤±æ•—", "warning");
            }
        }

        function showMessage(msg, type) {
            const el = document.getElementById('message-el');
            el.textContent = msg;
            el.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-yellow-100', 'text-yellow-700');
            
            if (type === 'error') el.classList.add('bg-red-100', 'text-red-700');
            else if (type === 'success') el.classList.add('bg-green-100', 'text-green-700');
            else el.classList.add('bg-yellow-100', 'text-yellow-700');
            
            el.classList.remove('hidden');
        }

        function doPunch(type) {
            const btnIn = document.getElementById('punch-in-btn');
            const btnOut = document.getElementById('punch-out-btn');
            
            btnIn.disabled = true;
            btnOut.disabled = true;
            
            document.getElementById('location-status').textContent = "å–å¾—åº§æ¨™ä¸­...";
            
            if (!navigator.geolocation) {
                showMessage("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½", "error");
                btnIn.disabled = false; btnOut.disabled = false;
                return;
            }

            navigator.geolocation.getCurrentPosition(
                async (pos) => {
                    userLat = pos.coords.latitude;
                    userLng = pos.coords.longitude;
                    document.getElementById('location-status').textContent = `æˆåŠŸ (${userLat.toFixed(4)}, ${userLng.toFixed(4)})`;
                    
                    try {
                        showMessage(`æ­£åœ¨ç‚º ${type} æ‰“å¡...`, "warning");
                        
                        // æ§‹å»º API URL
                        const baseUrl = window.location.href.split('?')[0];
                        const url = `${baseUrl}?action=punchFromLiff&userId=${userProfile.userId}&type=${encodeURIComponent(type)}&lat=${userLat}&lng=${userLng}&ip=${userIp}`;
                        
                        console.log("Calling URL:", url);
                        
                        const response = await fetch(url);
                        const result = await response.json();
                        
                        if (result.ok) {
                            showMessage(`æ‰“å¡æˆåŠŸï¼æ‚¨ç¾åœ¨å¯ä»¥é—œé–‰è¦–çª—`, "success");
                            setTimeout(() => liff.closeWindow(), 2000);
                        } else {
                            showMessage("æ‰“å¡å¤±æ•—: " + (result.msg || result.code), "error");
                            btnIn.disabled = false; btnOut.disabled = false;
                        }
                    } catch (err) {
                        showMessage("ä¼ºæœå™¨é€£ç·šå¤±æ•—", "error");
                        btnIn.disabled = false; btnOut.disabled = false;
                    }
                },
                (err) => {
                    document.getElementById('location-status').textContent = "å–å¾—åº§æ¨™å¤±æ•—";
                    showMessage("è«‹å‹™å¿…å…è¨±å®šä½æ¬Šé™æ‰èƒ½æ‰“å¡", "error");
                    btnIn.disabled = false; btnOut.disabled = false;
                },
                { enableHighAccuracy: true }
            );
        }

        init();
    </script>
</body>
</html>
